{% extends "base.html" %}

{% block title %}Bulk Create Assessments - School Fees Management{% endblock %}

{% block page_title %}Bulk Create Assessments{% endblock %}

{% block page_actions %}
<a href="{{ url_for('list_assessments') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Assessments
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-layer-group me-2"></i>Bulk Assessment Configuration
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="bulkAssessmentForm">
                    <!-- Term Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="term" class="form-label">Academic Term <span class="text-danger">*</span></label>
                            <select class="form-select" id="term" name="term" required>
                                <option value="">Select Term</option>
                                {% for term_obj in terms %}
                                <option value="{{ term_obj.term }}"
                                        data-year="{{ term_obj.year }}"
                                        {{ 'selected' if term_obj.is_current else '' }}>
                                    Term {{ term_obj.term }}/{{ term_obj.year }}
                                    {% if term_obj.is_current %} (Current){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="year" class="form-label">Academic Year <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="year" name="year"
                                   min="2020" max="2030" required readonly>
                        </div>
                    </div>

                    <!-- Student Selection Criteria -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Student Selection Criteria</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="class_id" class="form-label">Class (Optional)</label>
                                    <select class="form-select" id="class_id" name="class_id">
                                        <option value="">All Classes</option>
                                        {% for class_obj in classes %}
                                        <option value="{{ class_obj.id }}">{{ class_obj.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">Leave blank to include all classes</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="stream_id" class="form-label">Stream (Optional)</label>
                                    <select class="form-select" id="stream_id" name="stream_id" disabled>
                                        <option value="">All Streams</option>
                                    </select>
                                    <div class="form-text">Select a class first to enable stream filtering</div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="student_type" class="form-label">Student Type (Optional)</label>
                                    <select class="form-select" id="student_type" name="student_type">
                                        <option value="">All Student Types</option>
                                        <option value="DAY">Day Students</option>
                                        <option value="BOARDER">Boarder Students</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="mt-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="skip_existing"
                                                   name="skip_existing" checked>
                                            <label class="form-check-label" for="skip_existing">
                                                Skip students with existing assessments
                                            </label>
                                            <div class="form-text">Prevents duplicate assessments for the same term</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-eye me-2"></i>Assessment Preview
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="previewSection">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-search fa-2x mb-2"></i>
                                    <p>Configure criteria above and click "Preview" to see affected students</p>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-info" onclick="previewAssessments()">
                                    <i class="fas fa-search me-2"></i>Preview Students
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('list_assessments') }}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="fas fa-layer-group me-2"></i>Create Assessments
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Information Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>How Bulk Assessment Works
                </h6>
            </div>
            <div class="card-body">
                <ol class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>1. Select Term:</strong> Choose the academic term for assessments
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>2. Filter Students:</strong> Optionally filter by class, stream, or type
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>3. Preview:</strong> Review which students will be assessed
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>4. Generate:</strong> Create assessments with applicable fee rates
                    </li>
                </ol>
            </div>
        </div>

        <!-- Warning Panel -->
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Important Notes
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <small>Assessments are created based on configured fee rates</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <small>Transport fees calculated using student distance</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <small>Optional fees applied based on student services</small>
                    </li>
                    <li>
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <small>Existing assessments are skipped by default</small>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Statistics Panel -->
        <div class="card mt-4" id="statsPanel" style="display: none;">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Assessment Statistics
                </h6>
            </div>
            <div class="card-body">
                <div id="assessmentStats"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Auto-populate year when term is selected
    $('#term').on('change', function() {
        const selectedOption = $(this).find(':selected');
        const year = selectedOption.data('year');
        $('#year').val(year);

        // Reset preview
        resetPreview();
    });

    // Load streams when class is selected
    $('#class_id').on('change', function() {
        const classId = $(this).val();
        const streamSelect = $('#stream_id');

        streamSelect.empty().append('<option value="">All Streams</option>');

        if (classId) {
            streamSelect.prop('disabled', false);

            // Load streams for selected class
            $.get(`/get_streams/${classId}`)
                .done(function(streams) {
                    streams.forEach(function(stream) {
                        streamSelect.append(`<option value="${stream.id}">${stream.name}</option>`);
                    });
                })
                .fail(function() {
                    alert('Error loading streams');
                });
        } else {
            streamSelect.prop('disabled', true);
        }

        // Reset preview
        resetPreview();
    });

    // Reset preview when any filter changes
    $('#stream_id, #student_type, #skip_existing').on('change', function() {
        resetPreview();
    });

    // Set current term if available
    if ($('#term option[selected]').length > 0) {
        $('#term').trigger('change');
    }
});

function previewAssessments() {
    const formData = {
        term: $('#term').val(),
        year: $('#year').val(),
        class_id: $('#class_id').val(),
        stream_id: $('#stream_id').val(),
        student_type: $('#student_type').val(),
        skip_existing: $('#skip_existing').is(':checked')
    };

    if (!formData.term || !formData.year) {
        alert('Please select a term and year first');
        return;
    }

    // Show loading
    $('#previewSection').html(`
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading preview...</p>
        </div>
    `);

    // Simulate API call for preview (replace with actual endpoint)
    setTimeout(function() {
        const mockStudents = [
            { id: 1, admission_no: 'ST001', name: 'John Doe', class: 'Form 1', stream: 'A', type: 'DAY' },
            { id: 2, admission_no: 'ST002', name: 'Jane Smith', class: 'Form 1', stream: 'A', type: 'BOARDER' },
            { id: 3, admission_no: 'ST003', name: 'Bob Johnson', class: 'Form 1', stream: 'B', type: 'DAY' }
        ];

        displayPreview(mockStudents);
        updateStats(mockStudents);
    }, 1500);
}

function displayPreview(students) {
    if (students.length === 0) {
        $('#previewSection').html(`
            <div class="text-center text-muted py-3">
                <i class="fas fa-users-slash fa-2x mb-2"></i>
                <p>No students match the selected criteria</p>
            </div>
        `);
        $('#submitBtn').prop('disabled', true);
        return;
    }

    let html = `
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Admission No</th>
                        <th>Student Name</th>
                        <th>Class/Stream</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
    `;

    students.forEach(function(student) {
        html += `
            <tr>
                <td>${student.admission_no}</td>
                <td>${student.name}</td>
                <td>${student.class}${student.stream ? ' - ' + student.stream : ''}</td>
                <td>
                    <span class="badge bg-${student.type === 'DAY' ? 'info' : 'warning'} badge-sm">
                        ${student.type}
                    </span>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="alert alert-success mt-3">
            <i class="fas fa-check-circle me-2"></i>
            <strong>${students.length}</strong> students will be assessed for the selected term.
        </div>
    `;

    $('#previewSection').html(html);
    $('#submitBtn').prop('disabled', false);
}

function updateStats(students) {
    const dayStudents = students.filter(s => s.type === 'DAY').length;
    const boarderStudents = students.filter(s => s.type === 'BOARDER').length;

    const statsHtml = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-info">${students.length}</h4>
                <small>Total Students</small>
            </div>
            <div class="col-6">
                <h4 class="text-success">Est. KSh 450,000</h4>
                <small>Expected Revenue</small>
            </div>
        </div>
        <hr>
        <div class="row text-center">
            <div class="col-6">
                <h5 class="text-info">${dayStudents}</h5>
                <small>Day Students</small>
            </div>
            <div class="col-6">
                <h5 class="text-warning">${boarderStudents}</h5>
                <small>Boarders</small>
            </div>
        </div>
    `;

    $('#assessmentStats').html(statsHtml);
    $('#statsPanel').show();
}

function resetPreview() {
    $('#previewSection').html(`
        <div class="text-center text-muted py-3">
            <i class="fas fa-search fa-2x mb-2"></i>
            <p>Configure criteria above and click "Preview" to see affected students</p>
        </div>
    `);
    $('#submitBtn').prop('disabled', true);
    $('#statsPanel').hide();
}

// Form submission confirmation
$('#bulkAssessmentForm').on('submit', function(e) {
    if (!confirm('Are you sure you want to create assessments for the selected students? This action cannot be undone.')) {
        e.preventDefault();
    }
});
</script>
{% endblock %}