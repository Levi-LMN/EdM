{% extends "base.html" %}

{% block title %}Receipt {{ payment.receipt_number }}{% endblock %}
{% block page_title %}Payment Receipt{% endblock %}

{% block page_actions %}
<a href="{{ url_for('student_payments', student_id=payment.student_id) }}" class="btn btn-outline-primary">
    <i class="fas fa-arrow-left me-2"></i>Back to Payments
</a>
<a href="{{ url_for('print_receipt', payment_id=payment.id) }}" class="btn btn-primary" target="_blank">
    <i class="fas fa-print me-2"></i>Print Receipt
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Receipt Card -->
        <div class="card shadow-sm" id="receipt">
            <!-- Header -->
            <div class="card-body text-center border-bottom border-dark pb-3">
                <div class="d-flex justify-content-center align-items-center mb-3">
                    <div class="border border-3 border-dark rounded-circle d-flex align-items-center justify-content-center me-3"
                         style="width: 80px; height: 80px;">
                        <span class="fw-bold" style="font-size: 26px; color: #333;">SLM</span>
                    </div>
                    <div>
                        <h3 class="mb-0 fw-bold">ST. LUKE MOGOBICH ACADEMY</h3>
                        <p class="mb-0">P.O. BOX 1234-00100, Nairobi</p>
                        <p class="mb-0">Tel: 0706 950 210 / 0701 693 009</p>
                        <p class="mb-0">Email: stlukemogobich@gmail.com</p>
                        <p class="mb-0 fw-bold">Chokaa - Utawala Road</p>
                    </div>
                </div>
                <hr class="border-2 border-dark my-3">
                <h4 class="fw-bold text-decoration-underline">OFFICIAL RECEIPT</h4>
            </div>

            <!-- Receipt Details -->
            <div class="card-body p-3">
                <table class="table table-sm table-bordered mb-0">
                    <tbody>
                        <tr>
                            <td class="bg-light fw-bold">Receipt No:</td>
                            <td>{{ payment.receipt_number }}</td>
                            <td class="bg-light fw-bold">Date:</td>
                            <td>{{ payment.payment_date.strftime('%d %B %Y') }}</td>
                        </tr>
                        <tr>
                            <td class="bg-light fw-bold">Received From:</td>
                            <td colspan="3"><strong>{{ payment.student.full_name|upper }}</strong></td>
                        </tr>
                        <tr>
                            <td class="bg-light fw-bold">ADM No:</td>
                            <td>{{ payment.student.admission_no }}</td>
                            <td class="bg-light fw-bold">Class:</td>
                            <td>{{ payment.student.class_obj.name }}{% if payment.student.stream %} {{ payment.student.stream.name }}{% endif %}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Amount in Words -->
            <div class="card-body border-top border-bottom">
                <p class="fw-bold mb-0">Amount: {{ amount_to_words(payment.amount) }} Shillings Only</p>
            </div>

            <!-- Payment Breakdown -->
            <div class="card-body p-3">
                <table class="table table-sm table-bordered mb-0">
                    <thead class="bg-light text-uppercase text-center">
                        <tr>
                            <th>Votehead</th>
                            <th class="text-end" width="25%">Amount (KSh)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if payment.allocations %}
                            {% for allocation in payment.allocations %}
                            <tr>
                                <td>{{ allocation.assessment.fee_item.name }}</td>
                                <td class="text-end">{{ "%.2f"|format(allocation.amount) }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td>Unallocated Payment</td>
                                <td class="text-end">{{ "%.2f"|format(payment.amount) }}</td>
                            </tr>
                        {% endif %}

                        <tr>
                            <td>Prepayments</td>
                            <td class="text-end">0.00</td>
                        </tr>

                        {% set total_assessed = payment.student.fee_assessments|sum(attribute='amount') or 0 %}
                        {% set total_paid_allocations = [] %}
                        {% for assessment in payment.student.fee_assessments %}
                            {% for alloc in assessment.allocations %}
                                {% set _ = total_paid_allocations.append(alloc.amount) %}
                            {% endfor %}
                        {% endfor %}
                        {% set total_paid = total_paid_allocations|sum or 0 %}
                        {% set current_balance = total_assessed - total_paid %}

                        <tr class="table-light fw-bold">
                            <td>Fees Arrears</td>
                            <td class="text-end">{{ "%.2f"|format(current_balance) }}</td>
                        </tr>
                        <tr class="table-light fw-bold">
                            <td>Total Paid</td>
                            <td class="text-end">{{ "%.2f"|format(payment.amount) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer Info -->
            <div class="card-body border-top">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Balance:</strong> {{ "%.2f"|format(current_balance) }}</p>
                        <p class="mb-1"><strong>Payment Mode:</strong> {{ payment.payment_mode.value }}</p>
                        <p class="mb-0"><strong>Received By:</strong> {{ payment.processor.name if payment.processor else 'SYSTEM' }}</p>
                    </div>
                    <div class="col-md-6 text-end">
                        {% if payment.payment_mode.value == 'MPESA' and payment.mpesa_code %}
                            <p class="mb-1"><strong>M-PESA Code:</strong> {{ payment.mpesa_code }}</p>
                        {% elif payment.payment_mode.value == 'BANK' and payment.bank_slip_number %}
                            <p class="mb-1"><strong>Bank Slip:</strong> {{ payment.bank_slip_number }}</p>
                        {% elif payment.payment_mode.value == 'CHEQUE' and payment.cheque_number %}
                            <p class="mb-1"><strong>Cheque No:</strong> {{ payment.cheque_number }}</p>
                        {% endif %}
                        <p class="mb-0"><strong>Date:</strong> {{ payment.payment_date.strftime('%d/%m/%Y') }}</p>
                    </div>
                </div>
            </div>

            <!-- Footer Note -->
            <div class="card-body text-center border-top border-dark">
                <p class="mb-0"><small><em>Fees once paid is neither refundable nor transferable.</em></small></p>
            </div>
        </div>

        <!-- Action Buttons (Not printed) -->
        <div class="card mt-4 no-print">
            <div class="card-body">
                <h6 class="mb-3">Actions</h6>
                <div class="d-flex gap-2 flex-wrap">
                    {% if not payment.allocations %}
                    <a href="{{ url_for('allocate_payment', payment_id=payment.id) }}" class="btn btn-warning">
                        <i class="fas fa-tasks me-2"></i>Allocate Payment
                    </a>
                    {% endif %}
                    <a href="{{ url_for('student_detail', student_id=payment.student_id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-user me-2"></i>View Student Profile
                    </a>
                    <a href="{{ url_for('student_payments', student_id=payment.student_id) }}" class="btn btn-outline-info">
                        <i class="fas fa-list me-2"></i>All Student Payments
                    </a>
                    <a href="{{ url_for('download_receipt_pdf', payment_id=payment.id) }}" class="btn btn-outline-success">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
    #receipt {
        border: 2px solid #000;
        padding: 0;
        background: #fff;
    }

    table td, table th {
        vertical-align: middle !important;
        font-size: 0.95rem;
    }

    @media print {
        body {
            background: #fff !important;
            margin: 20mm;
        }

        #receipt {
            box-shadow: none;
            border: none;
        }

        .no-print, nav, .btn, .page-actions, .page-header {
            display: none !important;
        }

        table {
            border-color: #000 !important;
        }

        .border-dark {
            border-color: #000 !important;
        }

        @page {
            margin: 15mm;
        }
    }
</style>
{% endblock %}
