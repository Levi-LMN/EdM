<!-- fees/rate_form.html -->
{% extends "base.html" %}

{% block title %}Add Fee Rate - School Fees Management{% endblock %}
{% block page_title %}Add Fee Rate{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-dollar-sign me-2"></i>Fee Rate Information</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fee_item_id" class="form-label">Fee Item <span class="text-danger">*</span></label>
                                <select class="form-select" id="fee_item_id" name="fee_item_id" required onchange="toggleRateFields()">
                                    <option value="">Select Fee Item</option>
                                    {% for item in fee_items %}
                                    <option value="{{ item.id }}" data-per-km="{{ item.is_per_km|lower }}">
                                        {{ item.code }} - {{ item.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="class_id" class="form-label">Class <span class="text-danger">*</span></label>
                                <select class="form-select" id="class_id" name="class_id" onchange="loadStreams(this.value)" required>
                                    <option value="">Select Class</option>
                                    {% for class in classes %}
                                    <option value="{{ class.id }}">{{ class.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="stream_id" class="form-label">Stream</label>
                                <select class="form-select" id="stream_id" name="stream_id">
                                    <option value="">All Streams</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="student_type" class="form-label">Student Type</label>
                                <select class="form-select" id="student_type" name="student_type">
                                    <option value="">All Types</option>
                                    <option value="DAY">Day Students</option>
                                    <option value="BOARDER">Boarders</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="year" class="form-label">Year <span class="text-danger">*</span></label>
                                <select class="form-select" id="year" name="year" required>
                                    {% for term in terms %}
                                        {% if not loop.index0 or terms[loop.index0-1].year != term.year %}
                                        <option value="{{ term.year }}">{{ term.year }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="term" class="form-label">Term <span class="text-danger">*</span></label>
                                <select class="form-select" id="term" name="term" required>
                                    <option value="">Select Term</option>
                                    <option value="1">Term 1</option>
                                    <option value="2">Term 2</option>
                                    <option value="3">Term 3</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3" id="amount-field">
                                <label for="amount" class="form-label">Fixed Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">KSh</span>
                                    <input type="number" class="form-control" id="amount" name="amount"
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3" id="rate-field" style="display: none;">
                                <label for="rate_per_km" class="form-label">Rate per KM</label>
                                <div class="input-group">
                                    <span class="input-group-text">KSh</span>
                                    <input type="number" class="form-control" id="rate_per_km" name="rate_per_km"
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Fill in either Fixed Amount or Rate per KM based on the fee item type.
                        Per-KM items use the rate field, others use the fixed amount.
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('list_fee_rates') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Fee Rate
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadStreams(classId) {
    const streamSelect = document.getElementById('stream_id');
    streamSelect.innerHTML = '<option value="">All Streams</option>';

    if (classId) {
        fetch(`/get_streams/${classId}`)
            .then(response => response.json())
            .then(streams => {
                streams.forEach(stream => {
                    const option = document.createElement('option');
                    option.value = stream.id;
                    option.textContent = stream.name;
                    streamSelect.appendChild(option);
                });
            });
    }
}

function toggleRateFields() {
    const feeItemSelect = document.getElementById('fee_item_id');
    const selectedOption = feeItemSelect.options[feeItemSelect.selectedIndex];
    const isPerKm = selectedOption.getAttribute('data-per-km') === 'true';

    const amountField = document.getElementById('amount-field');
    const rateField = document.getElementById('rate-field');

    if (isPerKm) {
        amountField.style.display = 'none';
        rateField.style.display = 'block';
        document.getElementById('amount').required = false;
        document.getElementById('rate_per_km').required = true;
    } else {
        amountField.style.display = 'block';
        rateField.style.display = 'none';
        document.getElementById('amount').required = true;
        document.getElementById('rate_per_km').required = false;
    }
}
</script>
{% endblock %}