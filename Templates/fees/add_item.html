{% extends "base.html" %}

{% block title %}Add Fee Item - EduManage Pro{% endblock %}
{% block page_title %}Add New Fee Item{% endblock %}

{% block page_actions %}
<a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Fee Items
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Fee Item Details</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('fees.add_item') }}">
                    <div class="row">
                        <!-- Fee Name -->
                        <div class="col-md-8 mb-3">
                            <label for="name" class="form-label">Fee Name <span class="text-danger">*</span></label>
                            <input type="text" name="name" id="name" class="form-control"
                                   placeholder="e.g., Tuition Fee, Transport Fee" required>
                        </div>

                        <!-- Fee Code -->
                        <div class="col-md-4 mb-3">
                            <label for="code" class="form-label">Fee Code <span class="text-danger">*</span></label>
                            <input type="text" name="code" id="code" class="form-control"
                                   placeholder="e.g., TUITION" maxlength="20" required
                                   style="text-transform: uppercase;">
                            <small class="text-muted">Short unique code</small>
                        </div>

                        <!-- Description -->
                        <div class="col-12 mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea name="description" id="description" class="form-control" rows="2"
                                      placeholder="Brief description of this fee item"></textarea>
                        </div>

                        <!-- Fee Scope -->
                        <div class="col-md-6 mb-3">
                            <label for="scope" class="form-label">Fee Scope <span class="text-danger">*</span></label>
                            <select name="scope" id="scope" class="form-select" required>
                                <option value="">Select Scope</option>
                                <option value="UNIVERSAL">Universal - All Students</option>
                                <option value="CLASS_LEVEL">Class Level - Per Class</option>
                                <option value="STREAM_LEVEL">Stream Level - Per Stream</option>
                                <option value="INDIVIDUAL">Individual - Manually Assigned</option>
                            </select>
                            <small class="text-muted">How this fee applies to students</small>
                        </div>

                        <!-- Rate Type -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Rate Type</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_per_km" id="is_per_km" value="1">
                                <label class="form-check-label" for="is_per_km">
                                    <i class="fas fa-route me-1"></i>Per Kilometer Rate
                                </label>
                            </div>
                            <small class="text-muted">Check if this is a transport fee calculated per km</small>
                        </div>
                    </div>

                    <!-- Scope Explanations -->
                    <div class="alert alert-info mb-3">
                        <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Fee Scope Guide</h6>
                        <ul class="mb-0 small">
                            <li><strong>Universal:</strong> Same rate for everyone (e.g., exam fees)</li>
                            <li><strong>Class Level:</strong> Different rates per class (e.g., tuition varies by form)</li>
                            <li><strong>Stream Level:</strong> Different rates per stream (e.g., special programs)</li>
                            <li><strong>Individual:</strong> Manually assign to specific students (e.g., special needs)</li>
                        </ul>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Fee Item
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Common Fee Items Reference -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-list me-2"></i>Common School Fee Items</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-2">Academic Fees</h6>
                        <ul class="small">
                            <li>Tuition Fee (TUITION) - Class Level</li>
                            <li>Exam Fee (EXAM) - Universal</li>
                            <li>Lab Fee (LAB) - Class Level</li>
                            <li>Library Fee (LIBRARY) - Universal</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-2">Boarding & Services</h6>
                        <ul class="small">
                            <li>Boarding Fee (BOARDING) - Individual</li>
                            <li>Meals Fee (MEALS) - Individual</li>
                            <li>Transport Fee (TRANSPORT) - Individual, Per KM</li>
                            <li>Activities Fee (ACTIVITIES) - Universal</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-generate code from name
document.getElementById('name').addEventListener('input', function() {
    const codeInput = document.getElementById('code');

    if (!codeInput.value) {
        let code = this.value
            .toUpperCase()
            .replace(/[^A-Z\s]/g, '')
            .split(' ')
            .filter(word => word.length > 0)
            .map(word => word.substring(0, 4))
            .join('_');

        codeInput.value = code.substring(0, 20);
    }
});

// Convert code to uppercase
document.getElementById('code').addEventListener('input', function() {
    this.value = this.value.toUpperCase().replace(/[^A-Z0-9_]/g, '');
});

// Show/hide per km checkbox based on scope
document.getElementById('scope').addEventListener('change', function() {
    const perKmCheckbox = document.getElementById('is_per_km');
    const perKmContainer = perKmCheckbox.closest('.col-md-6');

    if (this.value === 'UNIVERSAL') {
        perKmContainer.style.opacity = '0.5';
        perKmCheckbox.disabled = true;
        perKmCheckbox.checked = false;
    } else {
        perKmContainer.style.opacity = '1';
        perKmCheckbox.disabled = false;
    }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const code = document.getElementById('code').value.trim();

    if (name.length < 3) {
        e.preventDefault();
        alert('Fee name must be at least 3 characters long');
        return false;
    }

    if (code.length < 2) {
        e.preventDefault();
        alert('Fee code must be at least 2 characters long');
        return false;
    }
});
</script>
{% endblock %}