{% extends "base.html" %}

{% block title %}Edit Fee Item - EduManage Pro{% endblock %}
{% block page_title %}Edit Fee Item: {{ fee_item.name }}{% endblock %}

{% block page_actions %}
<a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Fee Items
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Usage Warning -->
        {% if usage_stats %}
        <div class="alert alert-warning mb-4">
            <h6 class="mb-2"><i class="fas fa-exclamation-triangle me-2"></i>This Fee Item Is In Use</h6>
            <div class="row">
                <div class="col-md-3">
                    <strong>{{ usage_stats.total_rates }}</strong>
                    <br><small>Fee Rates</small>
                </div>
                <div class="col-md-3">
                    <strong>{{ usage_stats.total_assessments }}</strong>
                    <br><small>Assessments</small>
                </div>
                <div class="col-md-3">
                    <strong>{{ usage_stats.total_assignments }}</strong>
                    <br><small>Assignments</small>
                </div>
                <div class="col-md-3">
                    <strong>KES {{ "{:,.2f}".format(usage_stats.total_revenue) }}</strong>
                    <br><small>Total Revenue</small>
                </div>
            </div>
            <small class="text-muted mt-2 d-block">Be careful when editing - changes may affect existing data</small>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Fee Item Details</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('fees.edit_item', item_id=fee_item.id) }}">
                    <div class="row">
                        <!-- Fee Name -->
                        <div class="col-md-8 mb-3">
                            <label for="name" class="form-label">Fee Name <span class="text-danger">*</span></label>
                            <input type="text" name="name" id="name" class="form-control"
                                   value="{{ fee_item.name }}" required>
                        </div>

                        <!-- Fee Code -->
                        <div class="col-md-4 mb-3">
                            <label for="code" class="form-label">Fee Code <span class="text-danger">*</span></label>
                            <input type="text" name="code" id="code" class="form-control"
                                   value="{{ fee_item.code }}" maxlength="20" required
                                   style="text-transform: uppercase;"
                                   {% if existing_rates_count > 0 %}readonly title="Cannot change code - rates exist"{% endif %}>
                            {% if existing_rates_count > 0 %}
                            <small class="text-warning"><i class="fas fa-lock"></i> Code locked (rates exist)</small>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="col-12 mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea name="description" id="description" class="form-control" rows="2">{{ fee_item.description or '' }}</textarea>
                        </div>

                        <!-- Fee Scope -->
                        <div class="col-md-6 mb-3">
                            <label for="scope" class="form-label">Fee Scope <span class="text-danger">*</span></label>
                            <select name="scope" id="scope" class="form-select" required
                                    {% if existing_rates_count > 0 %}disabled title="Cannot change scope - rates exist"{% endif %}>
                                <option value="UNIVERSAL" {% if fee_item.scope.value == 'UNIVERSAL' %}selected{% endif %}>Universal - All Students</option>
                                <option value="CLASS_LEVEL" {% if fee_item.scope.value == 'CLASS_LEVEL' %}selected{% endif %}>Class Level - Per Class</option>
                                <option value="STREAM_LEVEL" {% if fee_item.scope.value == 'STREAM_LEVEL' %}selected{% endif %}>Stream Level - Per Stream</option>
                                <option value="INDIVIDUAL" {% if fee_item.scope.value == 'INDIVIDUAL' %}selected{% endif %}>Individual - Manually Assigned</option>
                            </select>
                            {% if existing_rates_count > 0 %}
                            <input type="hidden" name="scope" value="{{ fee_item.scope.value }}">
                            <small class="text-warning"><i class="fas fa-lock"></i> Scope locked (rates exist)</small>
                            {% endif %}
                        </div>

                        <!-- Rate Type -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Rate Type</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_per_km" id="is_per_km" value="1"
                                       {% if fee_item.is_per_km %}checked{% endif %}
                                       {% if existing_rates_count > 0 %}disabled title="Cannot change - rates exist"{% endif %}>
                                <label class="form-check-label" for="is_per_km">
                                    <i class="fas fa-route me-1"></i>Per Kilometer Rate
                                </label>
                            </div>
                            {% if existing_rates_count > 0 %}
                            <input type="hidden" name="is_per_km" value="{% if fee_item.is_per_km %}1{% endif %}">
                            <small class="text-warning"><i class="fas fa-lock"></i> Type locked (rates exist)</small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Info Box -->
                    {% if existing_rates_count > 0 %}
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Some fields are locked because {{ existing_rates_count }} fee rate(s) exist for this item.
                        You can still update the name and description.
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Update Fee Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Convert code to uppercase (if not readonly)
const codeInput = document.getElementById('code');
if (!codeInput.hasAttribute('readonly')) {
    codeInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9_]/g, '');
    });
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();

    if (name.length < 3) {
        e.preventDefault();
        alert('Fee name must be at least 3 characters long');
        return false;
    }
});
</script>
{% endblock %}