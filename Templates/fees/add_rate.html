{% extends "base.html" %}

{% block title %}Add Fee Rate - EduManage Pro{% endblock %}
{% block page_title %}Add New Fee Rate{% endblock %}

{% block page_actions %}
<a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Fees
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Fee Rate Configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('fees.add_rate') }}" id="feeRateForm">
                    <div class="row">
                        <!-- Fee Item -->
                        <div class="col-md-6 mb-3">
                            <label for="fee_item_id" class="form-label">Fee Item <span class="text-danger">*</span></label>
                            <select name="fee_item_id" id="fee_item_id" class="form-select" required>
                                <option value="">Select Fee Item</option>
                                {% for item in fee_items %}
                                <option value="{{ item.id }}"
                                        data-scope="{{ item.scope.value }}"
                                        data-per-km="{{ item.is_per_km }}">
                                    {{ item.name }} ({{ item.code }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Academic Period -->
                        <div class="col-md-3 mb-3">
                            <label for="term" class="form-label">Term <span class="text-danger">*</span></label>
                            <select name="term" id="term" class="form-select" required>
                                <option value="1">Term 1</option>
                                <option value="2">Term 2</option>
                                <option value="3">Term 3</option>
                            </select>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="year" class="form-label">Year <span class="text-danger">*</span></label>
                            <input type="number" name="year" id="year" class="form-select"
                                   value="{{ current_year.year if current_year else 2025 }}"
                                   min="2020" max="2100" required>
                        </div>

                        <!-- Applicability Section -->
                        <div class="col-12 mb-3">
                            <label class="form-label">Applies To</label>
                            <div id="scopeInfo" class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Select a fee item to see applicability options
                            </div>
                        </div>

                        <!-- Class Selection -->
                        <div class="col-md-6 mb-3" id="classSection" style="display: none;">
                            <label for="class_id" class="form-label">Class</label>
                            <select name="class_id" id="class_id" class="form-select">
                                <option value="">All Classes</option>
                                {% for class in classes %}
                                <option value="{{ class.id }}">{{ class.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Stream Selection -->
                        <div class="col-md-6 mb-3" id="streamSection" style="display: none;">
                            <label for="stream_id" class="form-label">Stream</label>
                            <select name="stream_id" id="stream_id" class="form-select" disabled>
                                <option value="">Select class first</option>
                            </select>
                        </div>

                        <!-- Student Type -->
                        <div class="col-md-6 mb-3">
                            <label for="student_type" class="form-label">Student Type</label>
                            <select name="student_type" id="student_type" class="form-select">
                                <option value="">All Types</option>
                                <option value="DAY">Day Students</option>
                                <option value="BOARDER">Boarders</option>
                            </select>
                            <small class="text-muted">Optional: Specify if rate varies by student type</small>
                        </div>

                        <!-- Amount Fields -->
                        <div class="col-md-6 mb-3" id="amountSection">
                            <label for="amount" class="form-label">Fixed Amount (KES) <span class="text-danger">*</span></label>
                            <input type="number" name="amount" id="amount" class="form-control"
                                   step="0.01" min="0" placeholder="0.00">
                        </div>

                        <div class="col-md-6 mb-3" id="perKmSection" style="display: none;">
                            <label for="rate_per_km" class="form-label">Rate Per KM (KES) <span class="text-danger">*</span></label>
                            <input type="number" name="rate_per_km" id="rate_per_km" class="form-control"
                                   step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>

                    <!-- Summary Box -->
                    <div class="alert alert-success mb-3" id="summaryBox" style="display: none;">
                        <h6 class="mb-2"><i class="fas fa-check-circle me-2"></i>Rate Summary</h6>
                        <div id="summaryContent"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Fee Rate
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Guide -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Fee Rate Guide</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0 small">
                    <li class="mb-2"><strong>Universal Fees:</strong> Set one rate for all students (e.g., Exam Fee: KES 500)</li>
                    <li class="mb-2"><strong>Class-Level Fees:</strong> Set different rates per class (e.g., Form 1 Tuition: KES 30,000)</li>
                    <li class="mb-2"><strong>Stream-Level Fees:</strong> Set specific rates per stream (e.g., Form 2-A: KES 35,000)</li>
                    <li class="mb-2"><strong>Per-KM Fees:</strong> For transport, set rate per kilometer (e.g., KES 10/km)</li>
                    <li><strong>Student Type:</strong> Optionally set different rates for Day vs Boarder students</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Stream data by class
const streamsByClass = {
    {% for class in classes %}
    {{ class.id }}: [
        {% for stream in class.streams %}
        {id: {{ stream.id }}, name: "{{ stream.name }}"}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Handle fee item selection
document.getElementById('fee_item_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const scope = selectedOption.dataset.scope;
    const isPerKm = selectedOption.dataset.perKm === 'True';

    const scopeInfo = document.getElementById('scopeInfo');
    const classSection = document.getElementById('classSection');
    const streamSection = document.getElementById('streamSection');
    const amountSection = document.getElementById('amountSection');
    const perKmSection = document.getElementById('perKmSection');
    const amountInput = document.getElementById('amount');
    const perKmInput = document.getElementById('rate_per_km');

    // Reset
    classSection.style.display = 'none';
    streamSection.style.display = 'none';
    document.getElementById('class_id').required = false;
    document.getElementById('stream_id').required = false;

    if (!scope) {
        scopeInfo.innerHTML = '<i class="fas fa-info-circle me-2"></i>Select a fee item to see applicability options';
        return;
    }

    // Show/hide amount fields based on rate type
    if (isPerKm) {
        amountSection.style.display = 'none';
        perKmSection.style.display = 'block';
        amountInput.required = false;
        perKmInput.required = true;
        amountInput.value = '';
    } else {
        amountSection.style.display = 'block';
        perKmSection.style.display = 'none';
        amountInput.required = true;
        perKmInput.required = false;
        perKmInput.value = '';
    }

    // Configure based on scope
    if (scope === 'UNIVERSAL') {
        scopeInfo.innerHTML = '<i class="fas fa-globe me-2"></i><strong>Universal Fee</strong> - This rate will apply to all students';
    } else if (scope === 'CLASS_LEVEL') {
        scopeInfo.innerHTML = '<i class="fas fa-school me-2"></i><strong>Class-Level Fee</strong> - Select a specific class or leave empty for all classes';
        classSection.style.display = 'block';
    } else if (scope === 'STREAM_LEVEL') {
        scopeInfo.innerHTML = '<i class="fas fa-users me-2"></i><strong>Stream-Level Fee</strong> - You must select both class and stream';
        classSection.style.display = 'block';
        streamSection.style.display = 'block';
        document.getElementById('class_id').required = true;
        document.getElementById('stream_id').required = true;
    } else if (scope === 'INDIVIDUAL') {
        scopeInfo.innerHTML = '<i class="fas fa-user me-2"></i><strong>Individual Fee</strong> - This rate is for reference. Assign to students individually.';
    }

    updateSummary();
});

// Handle class selection
document.getElementById('class_id').addEventListener('change', function() {
    const streamSelect = document.getElementById('stream_id');
    const classId = parseInt(this.value);

    streamSelect.innerHTML = '<option value="">Select Stream</option>';

    if (classId && streamsByClass[classId]) {
        streamsByClass[classId].forEach(stream => {
            const option = document.createElement('option');
            option.value = stream.id;
            option.textContent = stream.name;
            streamSelect.appendChild(option);
        });
        streamSelect.disabled = false;
    } else {
        streamSelect.disabled = true;
    }

    updateSummary();
});

// Update summary on any input change
['term', 'year', 'class_id', 'stream_id', 'student_type', 'amount', 'rate_per_km'].forEach(id => {
    document.getElementById(id).addEventListener('change', updateSummary);
    document.getElementById(id).addEventListener('input', updateSummary);
});

function updateSummary() {
    const feeItem = document.getElementById('fee_item_id');
    const term = document.getElementById('term').value;
    const year = document.getElementById('year').value;
    const classSelect = document.getElementById('class_id');
    const streamSelect = document.getElementById('stream_id');
    const studentType = document.getElementById('student_type').value;
    const amount = document.getElementById('amount').value;
    const perKm = document.getElementById('rate_per_km').value;

    if (!feeItem.value || !term || !year) {
        document.getElementById('summaryBox').style.display = 'none';
        return;
    }

    let summary = '<ul class="mb-0">';
    summary += `<li><strong>Fee:</strong> ${feeItem.options[feeItem.selectedIndex].text}</li>`;
    summary += `<li><strong>Period:</strong> Term ${term}, ${year}</li>`;

    if (classSelect.value) {
        summary += `<li><strong>Class:</strong> ${classSelect.options[classSelect.selectedIndex].text}`;
        if (streamSelect.value) {
            summary += ` - Stream ${streamSelect.options[streamSelect.selectedIndex].text}`;
        }
        summary += '</li>';
    } else {
        summary += '<li><strong>Applies To:</strong> All Classes</li>';
    }

    if (studentType) {
        summary += `<li><strong>Student Type:</strong> ${studentType}</li>`;
    }

    if (amount) {
        summary += `<li><strong>Amount:</strong> KES ${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</li>`;
    }

    if (perKm) {
        summary += `<li><strong>Rate:</strong> KES ${parseFloat(perKm).toLocaleString('en-US', {minimumFractionDigits: 2})} per kilometer</li>`;
    }

    summary += '</ul>';

    document.getElementById('summaryContent').innerHTML = summary;
    document.getElementById('summaryBox').style.display = 'block';
}

// Form validation
document.getElementById('feeRateForm').addEventListener('submit', function(e) {
    const amount = document.getElementById('amount').value;
    const perKm = document.getElementById('rate_per_km').value;
    const amountRequired = document.getElementById('amount').required;
    const perKmRequired = document.getElementById('rate_per_km').required;

    if (amountRequired && (!amount || parseFloat(amount) <= 0)) {
        e.preventDefault();
        alert('Please enter a valid amount greater than 0');
        return false;
    }

    if (perKmRequired && (!perKm || parseFloat(perKm) <= 0)) {
        e.preventDefault();
        alert('Please enter a valid rate per kilometer greater than 0');
        return false;
    }
});
</script>
{% endblock %}