{% extends "base.html" %}

{% block title %}Assess Fees - EduManage Pro{% endblock %}
{% block page_title %}Assess Student Fees{% endblock %}

{% block page_actions %}
<a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Fees
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Info Card -->
        <div class="alert alert-info mb-4">
            <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Fee Assessment Process</h6>
            <p class="mb-0">This tool generates fee assessments for students based on configured fee rates. Use the preview feature to see what will be created before committing.</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-invoice-dollar me-2"></i>Assessment Configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('fees.assess') }}" id="assessForm">
                    <div class="row">
                        <!-- Academic Period -->
                        <div class="col-md-6 mb-3">
                            <label for="term" class="form-label">Term <span class="text-danger">*</span></label>
                            <select name="term" id="term" class="form-select" required>
                                <option value="1">Term 1</option>
                                <option value="2">Term 2</option>
                                <option value="3">Term 3</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="year" class="form-label">Year <span class="text-danger">*</span></label>
                            <input type="number" name="year" id="year" class="form-control"
                                   value="{{ current_year.year if current_year else 2025 }}"
                                   min="2020" max="2100" required>
                        </div>

                        <!-- Assessment Scope -->
                        <div class="col-12 mb-3">
                            <label class="form-label">Assessment Scope <span class="text-danger">*</span></label>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="assessment_scope"
                                               id="scope_all" value="all" checked>
                                        <label class="form-check-label" for="scope_all">
                                            <i class="fas fa-globe me-1"></i>All Students
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="assessment_scope"
                                               id="scope_class" value="class">
                                        <label class="form-check-label" for="scope_class">
                                            <i class="fas fa-school me-1"></i>By Class
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="assessment_scope"
                                               id="scope_stream" value="stream">
                                        <label class="form-check-label" for="scope_stream">
                                            <i class="fas fa-users me-1"></i>By Stream
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="assessment_scope"
                                               id="scope_individual" value="individual">
                                        <label class="form-check-label" for="scope_individual">
                                            <i class="fas fa-user me-1"></i>Individual
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Class Selection -->
                        <div class="col-md-6 mb-3" id="classSection" style="display: none;">
                            <label for="class_id" class="form-label">Select Class <span class="text-danger">*</span></label>
                            <select name="class_id" id="class_id" class="form-select">
                                <option value="">Choose a class...</option>
                                {% for class in classes %}
                                <option value="{{ class.id }}">{{ class.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Stream Selection -->
                        <div class="col-md-6 mb-3" id="streamSection" style="display: none;">
                            <label for="stream_id" class="form-label">Select Stream <span class="text-danger">*</span></label>
                            <select name="stream_id" id="stream_id" class="form-select" disabled>
                                <option value="">Select class first...</option>
                            </select>
                        </div>

                        <!-- Student Selection -->
                        <div class="col-12 mb-3" id="studentSection" style="display: none;">
                            <label for="student_id" class="form-label">Select Student <span class="text-danger">*</span></label>
                            <input type="text" id="student_search" class="form-control mb-2"
                                   placeholder="Search by admission number or name...">
                            <select name="student_id" id="student_id" class="form-select" size="5">
                                <option value="">Type to search students...</option>
                            </select>
                        </div>

                        <!-- Options -->
                        <div class="col-12 mb-3">
                            <label class="form-label">Options</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="skip_existing"
                                               id="skip_existing" value="1" checked>
                                        <label class="form-check-label" for="skip_existing">
                                            Skip existing assessments
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="include_transport"
                                               id="include_transport" value="1" checked>
                                        <label class="form-check-label" for="include_transport">
                                            Include transport fees
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="force_regenerate"
                                               id="force_regenerate" value="1">
                                        <label class="form-check-label" for="force_regenerate">
                                            Force regenerate (overwrite)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                Force regenerate will delete and recreate assessments for the selected scope
                            </small>
                        </div>
                    </div>

                    <!-- Preview Results -->
                    <div id="previewResults" style="display: none;">
                        <div class="alert alert-success">
                            <h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Preview Results</h6>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="text-center p-3" style="background: rgba(255,255,255,0.5); border-radius: 10px;">
                                        <h4 class="mb-0" id="preview_students">0</h4>
                                        <small>Students</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3" style="background: rgba(255,255,255,0.5); border-radius: 10px;">
                                        <h4 class="mb-0" id="preview_assessments">0</h4>
                                        <small>Assessments</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3" style="background: rgba(255,255,255,0.5); border-radius: 10px;">
                                        <h4 class="mb-0" id="preview_skipped">0</h4>
                                        <small>Skipped</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3" style="background: rgba(255,255,255,0.5); border-radius: 10px;">
                                        <h4 class="mb-0" id="preview_total">KES 0.00</h4>
                                        <small>Total Amount</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Fee Breakdown -->
                            <div id="feeBreakdown" style="display: none;">
                                <h6 class="mb-2">Fee Breakdown:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Fee Item</th>
                                                <th>Students</th>
                                                <th>Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody id="feeBreakdownBody"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Warnings -->
                            <div id="warningsContainer" style="display: none;">
                                <h6 class="mb-2 text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Warnings:</h6>
                                <ul id="warningsList" class="mb-0"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <div>
                            <button type="button" class="btn btn-info" onclick="previewAssessment()">
                                <i class="fas fa-eye me-2"></i>Preview
                            </button>
                            <button type="submit" class="btn btn-success" id="submitBtn" disabled>
                                <i class="fas fa-check-circle me-2"></i>Generate Assessments
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Guide Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Assessment Guide</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0 small">
                    <li class="mb-2"><strong>Preview First:</strong> Always preview before generating to see what will be created</li>
                    <li class="mb-2"><strong>Skip Existing:</strong> Prevents duplicate assessments for students already assessed</li>
                    <li class="mb-2"><strong>Force Regenerate:</strong> Deletes existing assessments and creates new ones (use with caution)</li>
                    <li class="mb-2"><strong>Transport Fees:</strong> Only assessed for students assigned to vehicles with distance configured</li>
                    <li><strong>Missing Rates:</strong> Students without applicable rates will not be assessed</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Stream data by class
const streamsByClass = {
    {% for class in classes %}
    {{ class.id }}: [
        {% for stream in class.streams %}
        {id: {{ stream.id }}, name: "{{ stream.name }}"}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Handle scope selection
document.querySelectorAll('input[name="assessment_scope"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const classSection = document.getElementById('classSection');
        const streamSection = document.getElementById('streamSection');
        const studentSection = document.getElementById('studentSection');

        // Hide all sections
        classSection.style.display = 'none';
        streamSection.style.display = 'none';
        studentSection.style.display = 'none';

        // Remove required attributes
        document.getElementById('class_id').required = false;
        document.getElementById('stream_id').required = false;
        document.getElementById('student_id').required = false;

        // Show relevant sections
        if (this.value === 'class') {
            classSection.style.display = 'block';
            document.getElementById('class_id').required = true;
        } else if (this.value === 'stream') {
            classSection.style.display = 'block';
            streamSection.style.display = 'block';
            document.getElementById('class_id').required = true;
            document.getElementById('stream_id').required = true;
        } else if (this.value === 'individual') {
            studentSection.style.display = 'block';
            document.getElementById('student_id').required = true;
            loadStudents();
        }

        // Reset preview
        document.getElementById('previewResults').style.display = 'none';
        document.getElementById('submitBtn').disabled = true;
    });
});

// Handle class selection
document.getElementById('class_id').addEventListener('change', function() {
    const streamSelect = document.getElementById('stream_id');
    const classId = parseInt(this.value);

    streamSelect.innerHTML = '<option value="">Select Stream...</option>';

    if (classId && streamsByClass[classId]) {
        streamsByClass[classId].forEach(stream => {
            const option = document.createElement('option');
            option.value = stream.id;
            option.textContent = stream.name;
            streamSelect.appendChild(option);
        });
        streamSelect.disabled = false;
    } else {
        streamSelect.disabled = true;
    }

    // Reset preview
    document.getElementById('previewResults').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
});

// Load students for individual assessment
function loadStudents() {
    fetch('/api/students/active')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('student_id');
            select.innerHTML = '';

            data.students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.admission_no} - ${student.first_name} ${student.last_name} (${student.class_name})`;
                option.dataset.searchText = `${student.admission_no} ${student.first_name} ${student.last_name}`.toLowerCase();
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading students:', error);
            alert('Failed to load students');
        });
}

// Student search functionality
document.getElementById('student_search').addEventListener('input', function() {
    const searchText = this.value.toLowerCase();
    const options = document.getElementById('student_id').options;

    for (let i = 0; i < options.length; i++) {
        const option = options[i];
        const searchable = option.dataset.searchText || '';

        if (searchable.includes(searchText)) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    }
});

// Preview assessment
function previewAssessment() {
    const form = document.getElementById('assessForm');
    const formData = new FormData(form);
    formData.append('preview', '1');

    // Show loading
    const previewResults = document.getElementById('previewResults');
    previewResults.style.display = 'block';
    previewResults.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Generating preview...</p></div>';

    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPreview(data.data);
            document.getElementById('submitBtn').disabled = false;
        } else {
            alert('Preview failed: ' + data.message);
            previewResults.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Preview failed. Please check your selection and try again.');
        previewResults.style.display = 'none';
    });
}

function displayPreview(data) {
    document.getElementById('preview_students').textContent = data.students_count;
    document.getElementById('preview_assessments').textContent = data.assessments_count;
    document.getElementById('preview_skipped').textContent = data.skipped_count;
    document.getElementById('preview_total').textContent = data.total_amount;

    // Fee breakdown
    const breakdownContainer = document.getElementById('feeBreakdown');
    const breakdownBody = document.getElementById('feeBreakdownBody');

    if (data.fee_breakdown && data.fee_breakdown.length > 0) {
        breakdownBody.innerHTML = '';
        data.fee_breakdown.forEach(fee => {
            const row = `
                <tr>
                    <td><span class="badge bg-info">${fee.code}</span> ${fee.name}</td>
                    <td>${fee.students_count}</td>
                    <td><strong>${fee.amount}</strong></td>
                </tr>
            `;
            breakdownBody.innerHTML += row;
        });
        breakdownContainer.style.display = 'block';
    } else {
        breakdownContainer.style.display = 'none';
    }

    // Warnings
    const warningsContainer = document.getElementById('warningsContainer');
    const warningsList = document.getElementById('warningsList');

    if (data.warnings && data.warnings.length > 0) {
        warningsList.innerHTML = '';
        data.warnings.forEach(warning => {
            warningsList.innerHTML += `<li>${warning}</li>`;
        });
        warningsContainer.style.display = 'block';
    } else {
        warningsContainer.style.display = 'none';
    }

    document.getElementById('previewResults').style.display = 'block';
}

// Reset preview when options change
['skip_existing', 'include_transport', 'force_regenerate', 'term', 'year'].forEach(id => {
    document.getElementById(id).addEventListener('change', function() {
        document.getElementById('previewResults').style.display = 'none';
        document.getElementById('submitBtn').disabled = true;
    });
});

document.getElementById('stream_id').addEventListener('change', function() {
    document.getElementById('previewResults').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
});

document.getElementById('student_id').addEventListener('change', function() {
    document.getElementById('previewResults').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
});

// Form submission confirmation
document.getElementById('assessForm').addEventListener('submit', function(e) {
    const forceRegenerate = document.getElementById('force_regenerate').checked;

    if (forceRegenerate) {
        if (!confirm('⚠️ FORCE REGENERATE will delete existing assessments and create new ones.\n\nThis action cannot be undone. Are you sure you want to continue?')) {
            e.preventDefault();
            return false;
        }
    }

    const assessmentsCount = document.getElementById('preview_assessments').textContent;
    if (assessmentsCount === '0') {
        e.preventDefault();
        alert('No assessments will be created. Please check your configuration.');
        return false;
    }
});
</script>
{% endblock %}