{% extends "base.html" %}

{% block title %}Edit Fee Rate - EduManage Pro{% endblock %}
{% block page_title %}Edit Fee Rate{% endblock %}

{% block page_actions %}
<a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Fees
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Usage Warning -->
        {% if usage_stats %}
        <div class="alert alert-warning mb-4">
            <h6 class="mb-2"><i class="fas fa-exclamation-triangle me-2"></i>This Rate Is Being Used</h6>
            <div class="row">
                <div class="col-md-4">
                    <strong>{{ usage_stats.assessments_count }}</strong>
                    <br><small>Assessments Created</small>
                </div>
                <div class="col-md-4">
                    <strong>{{ usage_stats.students_affected }}</strong>
                    <br><small>Students Affected</small>
                </div>
                <div class="col-md-4">
                    <strong>KES {{ "{:,.2f}".format(usage_stats.total_amount) }}</strong>
                    <br><small>Total Assessed</small>
                </div>
            </div>
            <small class="text-muted mt-2 d-block">Changes will not affect existing assessments</small>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Fee Rate</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('fees.edit_rate', rate_id=fee_rate.id) }}" id="feeRateForm">
                    <div class="row">
                        <!-- Fee Item -->
                        <div class="col-md-6 mb-3">
                            <label for="fee_item_id" class="form-label">Fee Item <span class="text-danger">*</span></label>
                            <select name="fee_item_id" id="fee_item_id" class="form-select" required
                                    {% if existing_assessments_count > 0 %}disabled title="Cannot change - assessments exist"{% endif %}>
                                {% for item in fee_items %}
                                <option value="{{ item.id }}"
                                        data-scope="{{ item.scope.value }}"
                                        data-per-km="{{ item.is_per_km }}"
                                        {% if item.id == fee_rate.fee_item_id %}selected{% endif %}>
                                    {{ item.name }} ({{ item.code }})
                                </option>
                                {% endfor %}
                            </select>
                            {% if existing_assessments_count > 0 %}
                            <input type="hidden" name="fee_item_id" value="{{ fee_rate.fee_item_id }}">
                            <small class="text-warning"><i class="fas fa-lock"></i> Locked ({{ existing_assessments_count }} assessments)</small>
                            {% endif %}
                        </div>

                        <!-- Academic Period -->
                        <div class="col-md-3 mb-3">
                            <label for="term" class="form-label">Term <span class="text-danger">*</span></label>
                            <select name="term" id="term" class="form-select" required>
                                <option value="1" {% if fee_rate.term == 1 %}selected{% endif %}>Term 1</option>
                                <option value="2" {% if fee_rate.term == 2 %}selected{% endif %}>Term 2</option>
                                <option value="3" {% if fee_rate.term == 3 %}selected{% endif %}>Term 3</option>
                            </select>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="year" class="form-label">Year <span class="text-danger">*</span></label>
                            <input type="number" name="year" id="year" class="form-control"
                                   value="{{ fee_rate.year }}" min="2020" max="2100" required>
                        </div>

                        <!-- Class Selection -->
                        <div class="col-md-6 mb-3">
                            <label for="class_id" class="form-label">Class</label>
                            <select name="class_id" id="class_id" class="form-select">
                                <option value="">All Classes</option>
                                {% for class in classes %}
                                <option value="{{ class.id }}" {% if class.id == fee_rate.class_id %}selected{% endif %}>
                                    {{ class.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Stream Selection -->
                        <div class="col-md-6 mb-3">
                            <label for="stream_id" class="form-label">Stream</label>
                            <select name="stream_id" id="stream_id" class="form-select">
                                <option value="">All Streams</option>
                                {% if fee_rate.stream %}
                                <option value="{{ fee_rate.stream_id }}" selected>{{ fee_rate.stream.name }}</option>
                                {% endif %}
                            </select>
                        </div>

                        <!-- Student Type -->
                        <div class="col-md-6 mb-3">
                            <label for="student_type" class="form-label">Student Type</label>
                            <select name="student_type" id="student_type" class="form-select">
                                <option value="">All Types</option>
                                <option value="DAY" {% if fee_rate.student_type and fee_rate.student_type.value == 'DAY' %}selected{% endif %}>Day Students</option>
                                <option value="BOARDER" {% if fee_rate.student_type and fee_rate.student_type.value == 'BOARDER' %}selected{% endif %}>Boarders</option>
                            </select>
                        </div>

                        <!-- Active Status -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="is_active" value="1"
                                       {% if fee_rate.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    <i class="fas fa-check-circle me-1"></i>Active
                                </label>
                            </div>
                            <small class="text-muted">Inactive rates won't be used for new assessments</small>
                        </div>

                        <!-- Amount Fields -->
                        <div class="col-md-6 mb-3" id="amountSection">
                            <label for="amount" class="form-label">Fixed Amount (KES)</label>
                            <input type="number" name="amount" id="amount" class="form-control"
                                   step="0.01" min="0" placeholder="0.00"
                                   value="{{ fee_rate.amount if fee_rate.amount else '' }}">
                        </div>

                        <div class="col-md-6 mb-3" id="perKmSection">
                            <label for="rate_per_km" class="form-label">Rate Per KM (KES)</label>
                            <input type="number" name="rate_per_km" id="rate_per_km" class="form-control"
                                   step="0.01" min="0" placeholder="0.00"
                                   value="{{ fee_rate.rate_per_km if fee_rate.rate_per_km else '' }}">
                        </div>
                    </div>

                    <!-- Info Box -->
                    {% if existing_assessments_count > 0 %}
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Changing this rate will not affect the {{ existing_assessments_count }} existing assessment(s).
                        New assessments will use the updated rate.
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('fees.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Update Fee Rate
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Stream data by class
const streamsByClass = {
    {% for class in classes %}
    {{ class.id }}: [
        {% for stream in class.streams %}
        {id: {{ stream.id }}, name: "{{ stream.name }}"}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Handle class selection
document.getElementById('class_id').addEventListener('change', function() {
    const streamSelect = document.getElementById('stream_id');
    const classId = parseInt(this.value);
    const currentStreamId = {{ fee_rate.stream_id if fee_rate.stream_id else 'null' }};

    streamSelect.innerHTML = '<option value="">All Streams</option>';

    if (classId && streamsByClass[classId]) {
        streamsByClass[classId].forEach(stream => {
            const option = document.createElement('option');
            option.value = stream.id;
            option.textContent = stream.name;
            if (stream.id === currentStreamId) {
                option.selected = true;
            }
            streamSelect.appendChild(option);
        });
        streamSelect.disabled = false;
    } else {
        streamSelect.disabled = true;
    }
});

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
    const feeItem = document.getElementById('fee_item_id');
    const selectedOption = feeItem.options[feeItem.selectedIndex];
    const isPerKm = selectedOption.dataset.perKm === 'True';

    const amountSection = document.getElementById('amountSection');
    const perKmSection = document.getElementById('perKmSection');
    const amountInput = document.getElementById('amount');
    const perKmInput = document.getElementById('rate_per_km');

    if (isPerKm) {
        amountSection.style.display = 'none';
        perKmSection.style.display = 'block';
        amountInput.required = false;
        perKmInput.required = true;
    } else {
        amountSection.style.display = 'block';
        perKmSection.style.display = 'none';
        amountInput.required = true;
        perKmInput.required = false;
    }

    // Trigger class change to load streams
    if (document.getElementById('class_id').value) {
        document.getElementById('class_id').dispatchEvent(new Event('change'));
    }
});

// Form validation
document.getElementById('feeRateForm').addEventListener('submit', function(e) {
    const amount = document.getElementById('amount').value;
    const perKm = document.getElementById('rate_per_km').value;
    const amountRequired = document.getElementById('amount').required;
    const perKmRequired = document.getElementById('rate_per_km').required;

    if (amountRequired && (!amount || parseFloat(amount) <= 0)) {
        e.preventDefault();
        alert('Please enter a valid amount greater than 0');
        return false;
    }

    if (perKmRequired && (!perKm || parseFloat(perKm) <= 0)) {
        e.preventDefault();
        alert('Please enter a valid rate per kilometer greater than 0');
        return false;
    }
});
</script>
{% endblock %}