{% extends "base.html" %}

{% block title %}Fee Items & Rates - EduManage Pro{% endblock %}
{% block page_title %}Fee Items & Rates Management{% endblock %}

{% block page_actions %}
<a href="{{ url_for('fees.add_item') }}" class="btn btn-primary">
    <i class="fas fa-plus-circle me-2"></i>Add Fee Item
</a>
<a href="{{ url_for('fees.add_rate') }}" class="btn btn-outline-primary">
    <i class="fas fa-dollar-sign me-2"></i>Add Fee Rate
</a>
<a href="{{ url_for('fees.assess') }}" class="btn btn-outline-success">
    <i class="fas fa-file-invoice-dollar me-2"></i>Assess Fees
</a>
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-tags text-primary mb-2" style="font-size: 2rem;"></i>
                <h6 class="text-muted mb-2">Total Fee Items</h6>
                <h3 class="mb-0">{{ fee_items|length }}</h3>
                <small class="text-muted">{{ fee_items|selectattr('is_active')|list|length }} active</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-dollar-sign text-success mb-2" style="font-size: 2rem;"></i>
                <h6 class="text-muted mb-2">Fee Rates</h6>
                <h3 class="mb-0">{{ current_rates|length }}</h3>
                <small class="text-muted">Current term/year</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-school text-info mb-2" style="font-size: 2rem;"></i>
                <h6 class="text-muted mb-2">Classes</h6>
                <h3 class="mb-0">{{ classes|length }}</h3>
                <small class="text-muted">Academic levels</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-calendar-alt text-warning mb-2" style="font-size: 2rem;"></i>
                <h6 class="text-muted mb-2">Academic Year</h6>
                <h3 class="mb-0">{{ current_year.year if current_year else 'Not Set' }}</h3>
                <small class="text-muted">Current year</small>
            </div>
        </div>
    </div>
</div>

<!-- Fee Items Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Fee Items</h5>
        <span class="badge bg-primary">{{ fee_items|length }} Items</span>
    </div>
    <div class="card-body">
        {% if fee_items %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Scope</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in fee_items %}
                    <tr>
                        <td><span class="badge bg-info">{{ item.code }}</span></td>
                        <td>
                            <strong>{{ item.name }}</strong>
                            {% if item.description %}
                            <br><small class="text-muted">{{ item.description[:60] }}{% if item.description|length > 60 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ item.scope.value }}</span>
                        </td>
                        <td>
                            {% if item.is_per_km %}
                            <span class="badge bg-warning">Per KM</span>
                            {% else %}
                            <span class="badge bg-success">Fixed</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('fees.edit_item', item_id=item.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('item', {{ item.id }}, '{{ item.name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-tags fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No fee items created yet</h5>
            <p class="text-muted">Create your first fee item to get started</p>
            <a href="{{ url_for('fees.add_item') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-2"></i>Add Fee Item
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Current Fee Rates Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Current Fee Rates</h5>
        <span class="badge bg-success">{{ current_rates|length }} Rates</span>
    </div>
    <div class="card-body">
        {% if current_rates %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Fee Item</th>
                        <th>Term/Year</th>
                        <th>Applies To</th>
                        <th>Student Type</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rate in current_rates %}
                    <tr>
                        <td>
                            <span class="badge bg-info">{{ rate.fee_item.code }}</span>
                            <br><small class="text-muted">{{ rate.fee_item.name }}</small>
                        </td>
                        <td>
                            <strong>Term {{ rate.term }}</strong>
                            <br><small class="text-muted">{{ rate.year }}</small>
                        </td>
                        <td>
                            {% if rate.stream %}
                            <span class="badge bg-primary">{{ rate.class_obj.name }}-{{ rate.stream.name }}</span>
                            {% elif rate.class_obj %}
                            <span class="badge bg-primary">{{ rate.class_obj.name }}</span>
                            {% else %}
                            <span class="badge bg-secondary">All Students</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if rate.student_type %}
                            <span class="badge bg-warning">{{ rate.student_type.value }}</span>
                            {% else %}
                            <span class="badge bg-secondary">All Types</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if rate.amount %}
                            <strong>KES {{ "{:,.2f}".format(rate.amount) }}</strong>
                            {% endif %}
                            {% if rate.rate_per_km %}
                            <strong>KES {{ "{:,.2f}".format(rate.rate_per_km) }}</strong>/km
                            {% endif %}
                        </td>
                        <td>
                            {% if rate.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('fees.edit_rate', rate_id=rate.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('rate', {{ rate.id }}, '{{ rate.fee_item.name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-dollar-sign fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No fee rates set for current term</h5>
            <p class="text-muted">Add fee rates to start assessing fees</p>
            <a href="{{ url_for('fees.add_rate') }}" class="btn btn-primary">
                <i class="fas fa-dollar-sign me-2"></i>Add Fee Rate
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<form id="deleteForm" method="POST" style="display: none;">
</form>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete(type, id, name) {
    const confirmMsg = type === 'item'
        ? `Are you sure you want to delete the fee item "${name}"?\n\nThis action cannot be undone if there are no associated rates or assessments.`
        : `Are you sure you want to delete the fee rate for "${name}"?\n\nThis action cannot be undone if there are no associated assessments.`;

    if (confirm(confirmMsg)) {
        const form = document.getElementById('deleteForm');
        form.action = type === 'item'
            ? "{{ url_for('fees.delete_item', item_id=0) }}".replace('0', id)
            : "{{ url_for('fees.delete_rate', rate_id=0) }}".replace('0', id);
        form.submit();
    }
}

// Add smooth transitions
document.querySelectorAll('.table tr').forEach(row => {
    row.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.01)';
        this.style.transition = 'transform 0.2s ease';
    });

    row.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });
});
</script>
{% endblock %}