{% extends "base.html" %}

{% block title %}Edit Payment - {{ payment.receipt_number }}{% endblock %}
{% block page_title %}Edit Payment{% endblock %}

{% block page_actions %}
<a href="{{ url_for('payment_detail', payment_id=payment.id) }}" class="btn btn-outline-secondary">
    <i class="fas fa-times me-2"></i>Cancel
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- Warning Alert -->
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> Editing payment records should be done with caution. 
            Changes will be logged for audit purposes.
        </div>

        <!-- Payment Info Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Current Payment Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Receipt Number:</strong> {{ payment.receipt_number }}</p>
                        <p><strong>Student:</strong> {{ payment.student.full_name }}</p>
                        <p><strong>Current Amount:</strong> <span class="text-success">{{ payment.amount|currency }}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Payment Date:</strong> {{ payment.payment_date.strftime('%d %b %Y') }}</p>
                        <p><strong>Payment Mode:</strong> {{ payment.payment_mode.value }}</p>
                        <p><strong>Processed By:</strong> {{ payment.processor.name if payment.processor else '-' }}</p>
                    </div>
                </div>
                {% if payment.allocations %}
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    This payment has been allocated to fee assessments. Editing may affect student balances.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Edit Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>Edit Payment Details
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="editPaymentForm">
                    <div class="row">
                        <!-- Amount -->
                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">
                                Amount <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">KSh</span>
                                <input type="number" 
                                       class="form-control" 
                                       id="amount" 
                                       name="amount" 
                                       value="{{ payment.amount }}"
                                       step="0.01" 
                                       min="0.01" 
                                       required>
                            </div>
                        </div>

                        <!-- Payment Date -->
                        <div class="col-md-6 mb-3">
                            <label for="payment_date" class="form-label">
                                Payment Date <span class="text-danger">*</span>
                            </label>
                            <input type="date" 
                                   class="form-control" 
                                   id="payment_date" 
                                   name="payment_date" 
                                   value="{{ payment.payment_date.strftime('%Y-%m-%d') }}"
                                   required>
                        </div>

                        <!-- Payment Mode -->
                        <div class="col-md-6 mb-3">
                            <label for="payment_mode" class="form-label">
                                Payment Mode <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="payment_mode" name="payment_mode" required>
                                <option value="CASH" {% if payment.payment_mode.value == 'CASH' %}selected{% endif %}>Cash</option>
                                <option value="MPESA" {% if payment.payment_mode.value == 'MPESA' %}selected{% endif %}>M-PESA</option>
                                <option value="BANK" {% if payment.payment_mode.value == 'BANK' %}selected{% endif %}>Bank Transfer</option>
                                <option value="CHEQUE" {% if payment.payment_mode.value == 'CHEQUE' %}selected{% endif %}>Cheque</option>
                            </select>
                        </div>

                        <!-- Receipt Number (Read-only) -->
                        <div class="col-md-6 mb-3">
                            <label for="receipt_number" class="form-label">
                                Receipt Number
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="receipt_number" 
                                   value="{{ payment.receipt_number }}"
                                   disabled>
                            <small class="text-muted">Receipt number cannot be changed</small>
                        </div>
                    </div>

                    <!-- Payment Method Specific Fields -->
                    <div class="row">
                        <!-- M-PESA Code -->
                        <div class="col-md-6 mb-3 payment-field mpesa-field" 
                             style="{% if payment.payment_mode.value != 'MPESA' %}display: none;{% endif %}">
                            <label for="mpesa_code" class="form-label">M-PESA Code</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="mpesa_code" 
                                   name="mpesa_code" 
                                   value="{{ payment.mpesa_code or '' }}"
                                   placeholder="e.g., QDR5TXYZ89">
                        </div>

                        <!-- Bank Slip Number -->
                        <div class="col-md-6 mb-3 payment-field bank-field" 
                             style="{% if payment.payment_mode.value != 'BANK' %}display: none;{% endif %}">
                            <label for="bank_slip_number" class="form-label">Bank Slip Number</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="bank_slip_number" 
                                   name="bank_slip_number" 
                                   value="{{ payment.bank_slip_number or '' }}"
                                   placeholder="Enter bank slip number">
                        </div>

                        <!-- Cheque Number -->
                        <div class="col-md-6 mb-3 payment-field cheque-field" 
                             style="{% if payment.payment_mode.value != 'CHEQUE' %}display: none;{% endif %}">
                            <label for="cheque_number" class="form-label">Cheque Number</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="cheque_number" 
                                   name="cheque_number" 
                                   value="{{ payment.cheque_number or '' }}"
                                   placeholder="Enter cheque number">
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" 
                                  id="notes" 
                                  name="notes" 
                                  rows="3"
                                  placeholder="Enter any additional notes about this payment">{{ payment.notes or '' }}</textarea>
                    </div>

                    <!-- Reason for Edit -->
                    <div class="mb-3">
                        <label for="edit_reason" class="form-label">
                            Reason for Editing <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="edit_reason" 
                                  name="edit_reason" 
                                  rows="2"
                                  placeholder="Please provide a reason for editing this payment record"
                                  required></textarea>
                        <small class="text-muted">This will be logged for audit purposes</small>
                    </div>

                    <hr>

                    <!-- Submit Buttons -->
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('payment_detail', payment_id=payment.id) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Allocation Impact Warning -->
        {% if payment.allocations %}
        <div class="card mt-4">
            <div class="card-header bg-warning">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Allocation Impact
                </h6>
            </div>
            <div class="card-body">
                <p class="mb-2">This payment has been allocated to the following assessments:</p>
                <ul class="mb-0">
                    {% for allocation in payment.allocations %}
                    <li>
                        {{ allocation.assessment.fee_item.name }} 
                        (Term {{ allocation.assessment.term }}/{{ allocation.assessment.year }}) - 
                        {{ allocation.amount|currency }}
                    </li>
                    {% endfor %}
                </ul>
                <div class="alert alert-warning mt-3 mb-0">
                    <strong>Note:</strong> If you change the payment amount, you may need to reallocate the payment.
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
    .payment-field {
        transition: all 0.3s ease;
    }
</style>

<script>
$(document).ready(function() {
    // Show/hide payment method specific fields
    function updatePaymentFields() {
        const paymentMode = $('#payment_mode').val();
        
        $('.payment-field').hide();
        
        if (paymentMode === 'MPESA') {
            $('.mpesa-field').show();
        } else if (paymentMode === 'BANK') {
            $('.bank-field').show();
        } else if (paymentMode === 'CHEQUE') {
            $('.cheque-field').show();
        }
    }

    $('#payment_mode').on('change', updatePaymentFields);
    updatePaymentFields();

    // Form validation
    $('#editPaymentForm').on('submit', function(e) {
        const amount = parseFloat($('#amount').val());
        const editReason = $('#edit_reason').val().trim();

        if (amount <= 0) {
            e.preventDefault();
            alert('Amount must be greater than zero');
            return false;
        }

        if (editReason.length < 10) {
            e.preventDefault();
            alert('Please provide a detailed reason for editing (at least 10 characters)');
            return false;
        }

        // Confirm submission
        if (!confirm('Are you sure you want to save these changes? This action will be logged.')) {
            e.preventDefault();
            return false;
        }

        return true;
    });

    // Amount formatting
    $('#amount').on('blur', function() {
        const value = parseFloat($(this).val());
        if (!isNaN(value)) {
            $(this).val(value.toFixed(2));
        }
    });
});
</script>
{% endblock %}